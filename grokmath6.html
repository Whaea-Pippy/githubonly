<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Math Formula Builder</title>
<style>
  :root {
    --level-color: #FF6B6B;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: Arial, Helvetica, sans-serif;
    background: #f0f8ff;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  header {
    background: #222;
    color: white;
    padding: 12px;
    text-align: center;
    position: relative;
  }
  h1 { font-size: 24px; margin: 6px 0; }
  .score-display {
    position: absolute;
    top: 12px;
    right: 20px;
    background: rgba(255,255,255,0.95);
    color: #222;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 18px;
  }
  .nav-buttons {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    padding: 10px 0;
  }
  .nav-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    font-size: 24px;
    font-weight: bold;
    color: white;
    cursor: pointer;
    transition: all 0.2s;
  }
  .nav-btn.active {
    box-shadow: 0 0 15px 4px rgba(255,255,255,0.8);
    transform: scale(1.15);
  }
  main {
    flex: 1;
    padding: 20px;
    display: flex;
  }
  .formula-container {
    flex: 1;
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .prompt {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 20px;
    text-align: center;
  }
  .formula-area {
    background: #f8f8f8;
    border: 4px dashed #ccc;
    border-radius: 16px;
    min-height: 140px;
    width: 100%;
    max-width: 1000px;
    padding: 20px;
    margin-bottom: 20px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    font-size: 40px;
    font-weight: bold;
    transition: border-color 0.4s, background-color 0.4s;
  }
  .formula-area.correct { 
    border-color: #4CAF50; 
    background: #e8f5e9;
  }
  .formula-area.wrong { 
    border-color: #f44336; 
    background: #ffebee;
  }
  .formula-area.highlight { border-color: #4CAF50; }
  .formula-area.empty::before {
    content: "Drag or click symbols here to build the formula...";
    color: #aaa;
    font-style: italic;
    font-size: 26px;
    pointer-events: none;
  }
  .symbol-bank {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    gap: 15px;
    max-width: 1000px;
    width: 100%;
    margin-bottom: 20px;
  }
  .symbol {
    background: var(--level-color);
    color: white;
    width: 80px;
    height: 80px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    font-weight: bold;
    cursor: grab;
    user-select: none;
    transition: transform 0.15s;
  }
  .symbol:active { transform: scale(0.95); }
  .symbol.used {
    opacity: 0.4;
    pointer-events: none;
  }
  .placed-symbol {
    background: var(--level-color);
    color: white;
    padding: 12px 24px;
    border-radius: 16px;
    font-size: 40px;
    cursor: grab;
    user-select: none;
  }
  .controls {
    display: flex;
    gap: 15px;
    margin: 20px 0;
  }
  button {
    padding: 12px 30px;
    font-size: 18px;
    border: none;
    border-radius: 30px;
    cursor: pointer;
    transition: all 0.2s;
  }
  #check-btn { background: #4CAF50; color: white; }
  #clear-btn { background: #FF6B6B; color: white; }
  #answer-btn { background: #2196F3; color: white; }
  .feedback {
    font-size: 34px;
    font-weight: bold;
    min-height: 50px;
    margin: 10px 0;
  }
  .answer-display {
    font-size: 28px;
    font-weight: bold;
    color: #333;
    background: #e3f2fd;
    padding: 12px 24px;
    border-radius: 12px;
    margin-top: 15px;
    display: none;
    text-align: center;
    border: 2px solid #2196F3;
  }
</style>
</head>
<body>
<header>
  <h1>Math Formula Builder</h1>
  <div class="score-display" id="score-display">Score: 0/0</div>
  <div class="nav-buttons">
    <button class="nav-btn active" style="background:#FF6B6B" data-level="1">1</button>
    <button class="nav-btn" style="background:#FF8E53" data-level="2">2</button>
    <button class="nav-btn" style="background:#FFCC00" data-level="3">3</button>
    <button class="nav-btn" style="background:#9ACD32" data-level="4">4</button>
    <button class="nav-btn" style="background:#4CAF50" data-level="5">5</button>
    <button class="nav-btn" style="background:#20B2AA" data-level="6">6</button>
    <button class="nav-btn" style="background:#4682B4" data-level="7">7</button>
    <button class="nav-btn" style="background:#9370DB" data-level="8">8</button>
    <button class="nav-btn" style="background:#DA70D6" data-level="9">9</button>
    <button class="nav-btn" style="background:#FF69B4" data-level="10">10</button>
  </div>
</header>
<main>
  <div class="formula-container">
    <div class="prompt" id="prompt"></div>
    <div class="formula-area empty" id="formula-area"></div>
    <div class="symbol-bank" id="symbol-bank"></div>
    <div class="controls">
      <button id="check-btn">Check Formula âœ“</button>
      <button id="clear-btn">Clear</button>
      <button id="answer-btn">Show Answer</button>
    </div>
    <div class="feedback" id="feedback"></div>
    <div class="answer-display" id="answer-display"></div>
  </div>
</main>

<script>
const STORAGE_KEY = 'math_formula_builder_score';
const ACTIVITY_NAME = 'formula_builder';

let scores = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
if (!scores[ACTIVITY_NAME]) scores[ACTIVITY_NAME] = { correct: 0, total: 0 };
localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));

const scoreEl = document.getElementById('score-display');
function updateScoreDisplay() {
  const s = scores[ACTIVITY_NAME];
  scoreEl.textContent = `Score: ${s.correct}/${s.total}`;
}

const colors = ['#FF6B6B','#FF8E53','#FFCC00','#9ACD32','#4CAF50','#20B2AA','#4682B4','#9370DB','#DA70D6','#FF69B4'];

const formulae = [
  [], // Level 0 unused
  [ // Level 1
    {prompt: "Area of a rectangle", symbols: ["A", "=", "l", "Ã—", "w"], correctOptions: [["A", "=", "l", "Ã—", "w"], ["A", "=", "w", "Ã—", "l"]]},
    {prompt: "Perimeter of a rectangle", symbols: ["P", "=", "2", "(", "l", "+", "w", ")"], correctOptions: [["P", "=", "2", "(", "l", "+", "w", ")"]]},
    {prompt: "Area of a triangle", symbols: ["A", "=", "1/2", "b", "Ã—", "h"], correctOptions: [["A", "=", "1/2", "b", "Ã—", "h"], ["A", "=", "1/2", "h", "Ã—", "b"]]},
    {prompt: "Circumference of a circle", symbols: ["C", "=", "2", "Ï€", "r"], correctOptions: [["C", "=", "2", "Ï€", "r"]]},
    {prompt: "Area of a circle", symbols: ["A", "=", "Ï€", "r", "Â²"], correctOptions: [["A", "=", "Ï€", "r", "Â²"]]}
  ],
  // Level 2
  [ // Add your full levels here...
    {prompt: "Volume of a cuboid", symbols: ["V", "=", "l", "Ã—", "w", "Ã—", "h"], correctOptions: [["V", "=", "l", "Ã—", "w", "Ã—", "h"], ["V", "=", "l", "Ã—", "h", "Ã—", "w"], ["V", "=", "w", "Ã—", "l", "Ã—", "h"], ["V", "=", "w", "Ã—", "h", "Ã—", "l"], ["V", "=", "h", "Ã—", "l", "Ã—", "w"], ["V", "=", "h", "Ã—", "w", "Ã—", "l"]]},
    // ... add more
  ],
  // Add levels 3â€“10 from your original code
];

let currentLevel = 1;
let currentFormulaIndex = 0;

const promptEl = document.getElementById("prompt");
const formulaArea = document.getElementById("formula-area");
const bank = document.getElementById("symbol-bank");
const feedback = document.getElementById("feedback");
const checkBtn = document.getElementById("check-btn");
const clearBtn = document.getElementById("clear-btn");
const answerBtn = document.getElementById("answer-btn");
const answerDisplay = document.getElementById("answer-display");

// Drag and drop
let draggedItem = null;

function loadFormula() {
  const f = formulae[currentLevel][currentFormulaIndex];
  promptEl.textContent = "Build the formula for: " + f.prompt;

  formulaArea.innerHTML = "";
  formulaArea.classList.remove("correct", "wrong");
  formulaArea.classList.add("empty");
  bank.innerHTML = "";
  feedback.textContent = "";
  answerDisplay.style.display = "none";
  checkBtn.disabled = false;

  const col = colors[currentLevel - 1];
  document.documentElement.style.setProperty('--level-color', col);
  document.body.style.background = col + '22';

  const symbols = shuffle([...f.symbols]);

  symbols.forEach(s => {
    const div = document.createElement("div");
    div.className = "symbol";
    div.draggable = true;
    div.textContent = s;
    div.dataset.symbol = s;

    div.addEventListener('dragstart', (e) => {
      if (div.classList.contains("used")) return;
      draggedItem = div;
      e.dataTransfer.setData("text/plain", s);
      setTimeout(() => div.style.opacity = "0.4", 0);
    });

    div.addEventListener('dragend', () => {
      div.style.opacity = "1";
      draggedItem = null;
    });

    div.onclick = () => {
      if (!div.classList.contains("used")) {
        div.classList.add("used");
        addToFormula(s);
      }
    };

    bank.appendChild(div);
  });

  document.querySelectorAll(".nav-btn").forEach(b => {
    b.classList.toggle("active", Number(b.dataset.level) === currentLevel);
  });
}

function addToFormula(symbol) {
  const item = document.createElement("div");
  item.className = "placed-symbol";
  item.draggable = true;
  item.textContent = symbol;
  item.dataset.symbol = symbol;

  item.addEventListener('dragstart', (e) => {
    draggedItem = item;
    e.dataTransfer.setData("text/plain", symbol);
  });

  item.addEventListener('dragend', () => draggedItem = null);

  item.onclick = () => {
    item.remove();
    const orig = [...bank.children].find(el => el.dataset.symbol === symbol && el.classList.contains("used"));
    if (orig) orig.classList.remove("used");
    if (!formulaArea.children.length) formulaArea.classList.add("empty");
  };

  formulaArea.appendChild(item);
  formulaArea.classList.remove("empty");
}

// Drag events
formulaArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  formulaArea.classList.add("highlight");
});

formulaArea.addEventListener('dragleave', () => {
  formulaArea.classList.remove("highlight");
});

formulaArea.addEventListener('drop', (e) => {
  e.preventDefault();
  formulaArea.classList.remove("highlight");

  if (draggedItem) {
    const symbol = e.dataTransfer.getData("text/plain");
    if (draggedItem.parentElement === bank) {
      draggedItem.classList.add("used");
      addToFormula(symbol);
    } else if (draggedItem.parentElement === formulaArea) {
      const rect = formulaArea.getBoundingClientRect();
      const x = e.clientX - rect.left;
      let insertBefore = null;
      for (const child of formulaArea.children) {
        const childRect = child.getBoundingClientRect();
        if (x < childRect.left - rect.left + childRect.width / 2) {
          insertBefore = child;
          break;
        }
      }
      if (insertBefore) formulaArea.insertBefore(draggedItem, insertBefore);
    }
  }
});

// Check button
checkBtn.onclick = () => {
  const built = [...formulaArea.children].map(el => el.textContent);
  const f = formulae[currentLevel][currentFormulaIndex];

  scores[ACTIVITY_NAME].total++;
  const isCorrect = f.correctOptions.some(opt => 
    opt.length === built.length && opt.every((v,i) => v === built[i])
  );

  formulaArea.classList.remove("correct", "wrong");
  if (isCorrect) {
    formulaArea.classList.add("correct");
    feedback.textContent = "ðŸŽ‰ Perfect formula!";
    feedback.style.color = "#4CAF50";
    scores[ACTIVITY_NAME].correct++;
    checkBtn.disabled = true;
    setTimeout(() => {
      currentFormulaIndex++;
      if (currentFormulaIndex >= formulae[currentLevel].length) currentFormulaIndex = 0;
      loadFormula();
    }, 1800);
  } else {
    formulaArea.classList.add("wrong");
    feedback.textContent = "âŒ Wrong â€“ try again!";
    feedback.style.color = "#f44336";
  }
  updateScoreDisplay();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(scores));
};

// Show answer
answerBtn.onclick = () => {
  const f = formulae[currentLevel][currentFormulaIndex];
  const correct = f.correctOptions[0]; // Show the first correct version
  answerDisplay.textContent = "Correct formula: " + correct.join(" ");
  answerDisplay.style.display = "block";
};

// Clear
clearBtn.onclick = () => {
  formulaArea.innerHTML = "";
  formulaArea.classList.add("empty");
  formulaArea.classList.remove("correct", "wrong");
  [...bank.children].forEach(el => el.classList.remove("used"));
  feedback.textContent = "";
  answerDisplay.style.display = "none";
  checkBtn.disabled = false;
};

// Level switch
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.onclick = () => {
    currentLevel = Number(btn.dataset.level);
    currentFormulaIndex = 0;
    loadFormula();
  };
});

function shuffle(array) {
  return array.map(a => [Math.random(), a]).sort((a,b) => a[0] - b[0]).map(a => a[1]);
}

updateScoreDisplay();
loadFormula();
</script>
</body>
</html>
